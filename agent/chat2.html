<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>LangGraph æµå¼æ¼”ç¤º</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    #chat { border: 1px solid #a3e2f9; height: 500px; overflow-y: auto; padding: 10px; background: #fafafa; }
    #inputBox { width: 70%; padding: 6px; }
    button { padding: 6px 12px; }
    .plan-box {
      background: #afcfeb;
      border-left: 4px solid #2196F3;
      padding: 8px 12px;
      margin: 6px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h3>LangGraph æµå¼è¾“å‡ºæ¼”ç¤º</h3>
  <div id="chat"></div>
  <input id="inputBox" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€" />
  <button onclick="sendMessage()">å‘é€</button>

  <script>
    const API_BASE = "http://127.0.0.1:2024";   // ä¸ä½ çš„ langgraph dev åœ°å€ä¸€è‡´

    let threadId = null;
    /* 1. åˆ›å»ºçº¿ç¨‹ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰ */
    async function createThread() {
      const res = await fetch(`${API_BASE}/threads`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      });
      if (!res.ok) throw new Error("åˆ›å»ºçº¿ç¨‹å¤±è´¥");
      const data = await res.json();
      threadId = data.thread_id;
      console.log("çº¿ç¨‹ ID:", threadId);
    }

    /* 2. å‘é€æ¶ˆæ¯å¹¶æµå¼æ¥æ”¶ */
    async function sendMessage() {
      const msg = inputBox.value.trim();
      if (!msg) return;
      inputBox.value = "";
      appendChat("user", msg);
      console.log("å½“å‰ID:", threadId);
      // 3. å‘èµ·æµå¼è¯·æ±‚ï¼ˆcustom æ¨¡å¼ï¼Œåç«¯ç”¨ writer å‘ JSONï¼‰
      const resp = await fetch(`${API_BASE}/threads/${threadId}/runs/stream`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          assistant_id: "bridge_stream",   // ä½ çš„ graph æ³¨å†Œå
          input: { messages: [{ role: "user", content: msg }] },
          stream_mode: "custom"            // å¯¹åº”åç«¯ writer(...) 
        })
      });

      if (!resp.ok) {
        console.error("è¿è¡Œå¤±è´¥", resp.status, resp.statusText);
        return;
      }

      /* 4. é€å—è§£æ */
      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      appendChat("bot", "");          // å…ˆå ä¸€è¡Œ
      const botSpan = document.querySelector('#chat > div:last-child > span');

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop() ?? "";   // æœ€åä¸€è¡Œå¯èƒ½ä¸å®Œæ•´ï¼Œç•™åˆ°ä¸‹æ¬¡
        for (const l of lines) {
          if (l.startsWith("data: ")) {
            const jsonText = l.slice(6).trim();
            if (!jsonText) continue;  // å¿ƒè·³è¡Œ
            try {
              const chunk = JSON.parse(jsonText);
              // æŒ‰åç«¯ writer çš„å­—æ®µç»“æ„è§£æ
              if (chunk.event_type === "custom_stream") {
                botSpan.insertAdjacentText("beforeend", chunk.reply);
                
              }
              else if (chunk.event === "plan_start") {
                appendPhase(chunk.text);
                console.log("æ”¶åˆ°:", chunk.text);
              }
              else if (chunk.event === "plan_final") {   // åç«¯ä¸€æ¬¡æ€§æ¨æˆå“
                renderPlan(chunk.plan);
                console.log("æ”¶åˆ°:", chunk.plan);
              }
            } catch (e) {
              console.warn("è§£æå¤±è´¥", jsonText, e);
            }
          }
        }
      }
      console.log("æµå¼è¾“å‡ºå®Œæ¯•");
    }

    /* å·¥å…·å‡½æ•° */
    function appendChat(role, text) {
      const div = document.createElement("div");
      div.style.margin = "4px 0";
      div.innerHTML = `<b>${role}:</b> <span>${text}</span>`;
      document.getElementById("chat").appendChild(div);
      div.scrollIntoView();
    }

    /* æ¸²æŸ“è®¡åˆ’å¡ç‰‡ */
    function renderPlan(planArr) {
      const box = document.createElement("div");
      box.className = "plan-box";
      box.innerHTML = "<b>ğŸ“‹ æ‰§è¡Œè®¡åˆ’</b><ol>" +
        planArr.map(p => `<li><code>${p.tool}</code> ${p.desc||""}</li>`).join("") +
        "</ol>";
      document.getElementById("chat").appendChild(box);
      box.scrollIntoView();
    }

    /* çº¯æ–‡æœ¬é˜¶æ®µæç¤º */
    function appendPhase(text) {
      const div = document.createElement("div");
      div.style.color = "#666";
      div.textContent = text;
      document.getElementById("chat").appendChild(div);
      div.scrollIntoView();
    }
    /* åˆå§‹åŒ– */
    (async () => {
      await createThread();
    })();
  </script>
</body>
</html>